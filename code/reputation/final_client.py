# Script to send files from one computer to another computer.

import socket
import time
timeout = time.time() + 60   # 60 seconds

import json
with open('setting_client.json') as json_data:
    setting_client = json.load(json_data)
TCP_IP = setting_client['TCP_IP']
TCP_PORT = setting_client['TCP_PORT']
BUFFER_SIZE = setting_client['BUFFER_SIZE']

def sendFile(FILE_PATH,TCP_IP,TCP_PORT,BUFFER_SIZE,MAC_ADDRESS):
    # Socket creation and setup
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((TCP_IP, TCP_PORT))

    #Send mac address and wait for response
    s.send(MAC_ADDRESS+'\n')
    res = getAcknowledgement(s)
    if (res == 'clear_to_send_name'):
        print 'Your file is healthy !!'
        s.send(FILE_PATH+'\n')
        res = getAcknowledgement(s)
        if (res == 'clear_to_send_file'):
            sendFileContent(s, FILE_PATH)
        else:
            print 'Unexpected response code !! Error: '+res
    elif (res == 'file_discarded'):
        print 'Your file is malicious !!'
    else:
        print 'Unexpected response code !! Error: '+res
    s.close()


def getAcknowledgement(s):
    while True:
        res = s.recv(BUFFER_SIZE)
        res = res.strip()
        if time.time() > timeout:
            break
        if res:
            return res
    return ''


def sendFileContent(s, FILE_PATH):
    f = open(FILE_PATH,'rb')
    while True:
        l = f.read(BUFFER_SIZE)
        while (l):
            s.send(l)
            l = f.read(BUFFER_SIZE)
        if not l:
            f.close()
            break
    print('File successfully send')


sendFile('/home/prashant/Pictures/signin.png',TCP_IP,TCP_PORT,BUFFER_SIZE,'a1:25:d5:f3:cb:22')
